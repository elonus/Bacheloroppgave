---
title: "Bachelor"
author: "Andreas Matre"
date: "2/11/2020"
output: 
  pdf_document:
    toc: true
    number_sections: true
        #html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(survey)
library(ggplot2)
library(ggfortify)
library(cowplot)
library(dplyr)
```




```{r, include = FALSE}
anthsrs <- SDaA::anthsrs
anthuneq <- SDaA::anthuneq
anthuneq$weights <- 1/anthuneq$prob
anthuneq$height = anthuneq$height*2.54
anthsrs$height = anthsrs$height*2.54
```

```{r, echo = FALSE, warning = FALSE}
ggplot() + geom_point(data = anthsrs, aes(finger, height)) + ylim(60, 70) + xlim(10, 13) +
  theme(axis.title = element_text(size = 20),
        axis.text = element_text(size = 14))
```

```{r, echo = FALSE, warning = FALSE}
ggplot() + geom_point(data = anthuneq, aes(finger, height)) + ylim(60, 70) + xlim(10, 13) +
  theme(axis.title = element_text(size = 20),
        axis.text = element_text(size = 14))
```


```{r}
anthuneq.svy <- svydesign(ids = ~0, weights = ~weights, data = anthuneq)

normalmod <- lm(height ~ finger, data = anthuneq)
survmod <- svyglm(height ~ finger, design = anthuneq.svy)

normalcoef <- summary(normalmod)$coefficients
survcoef <- summary(survmod)$coefficients
```

```{r}
## Bootstrap
#B = 10000
#
#coefs <- sapply(1:B, function(x) {
#  indeces <- sample(1:nrow(anthuneq), size = nrow(anthuneq), replace = TRUE)
#  s <- anthuneq[indeces,]
#  s.svy <- svydesign(ids = ~0, weights = ~weights, data = s)
#  mod <- svyglm(height ~ finger, design = s.svy)
#  return(summary(mod)$coefficients[,1])
#})
#
#intercept.var <- var(coefs[1,])
#finger.var <- var(coefs[2,])
#intercept.finger.cov <- cov(coefs[1,], coefs[2,])

```

```{r}
x.vals = seq(from = 9.5, to = 13.5, by = 0.1)
#predict.int.normalmod <- as.data.frame(predict(normalmod, newdata = data.frame(finger = x.vals), interval = "pred"))
#predict.int.normalmod$x.vals <- x.vals

normal.cov <- vcov(normalmod)
predict.normalmod <- predict(normalmod, newdata = data.frame(finger = x.vals))
predict.int.normalmod <- data.frame(fit = predict.normalmod)
predict.int.normalmod$x.vals <- x.vals
#predict.int.normalmod$se <- sqrt(intercept.var + predict.int.normalmod$x.vals^2 * finger.var + 2*predict.int.normalmod$x.vals * intercept.finger.cov)
predict.int.normalmod$se <- sqrt(summary(normalmod)$sigma^2 + cov.matrix[1, 1] + predict.int.normalmod$x.vals^2 * cov.matrix[2, 2] + 2*predict.int.normalmod$x.vals * cov.matrix[1, 2])
predict.int.normalmod$lwr <- predict.int.normalmod$fit - predict.int.normalmod$se * qt(0.975, df = nrow(anthuneq))
predict.int.normalmod$upr <- predict.int.normalmod$fit + predict.int.normalmod$se * qt(0.975, df = nrow(anthuneq))

cov.matrix <- vcov(survmod)

predict.survmod <- as.data.frame(predict(survmod, newdata = data.frame(finger = x.vals), se=TRUE))
predict.int.survmod <- data.frame(fit = predict.survmod$link)
predict.int.survmod$x.vals <- x.vals
#predict.int.survmod$se <- sqrt(intercept.var + predict.int.survmod$x.vals^2 * finger.var + 2*predict.int.survmod$x.vals * intercept.finger.cov)
predict.int.survmod$se <- sqrt(var(survmod$residuals) + cov.matrix[1, 1] + predict.int.survmod$x.vals^2 * cov.matrix[2, 2] + 2*predict.int.survmod$x.vals * cov.matrix[1, 2])
predict.int.survmod$lower <- predict.int.survmod$fit - predict.int.survmod$se * qt(0.975, df = nrow(anthuneq))
predict.int.survmod$upper <- predict.int.survmod$fit + predict.int.survmod$se * qt(0.975, df = nrow(anthuneq))
```


```{r}
#prop = 0.0001
#size.uneq <- ceiling(anthuneq$weights)
#size.uneq <- replace(size.uneq, size.uneq == 1384, prop * 1384)
#size.uneq <- replace(size.uneq, size.uneq == 2767, prop * 2767)
#size.uneq <- replace(size.uneq, size.uneq == 16584, prop * 16584)
#size.uneq <- replace(size.uneq, size.uneq == 33223, prop * 33223)

size.uneq <- rep(0.8, length(nrow(anthuneq)))
size.srs <- rep(0.8, length(nrow(anthuneq)))

base <- ggplot() + xlim(10, 13) + ylim(147, 183)

uneq.surv.plot <- base +
  geom_point(data = anthuneq, aes(finger, height), size = size.uneq) +
  geom_abline(slope = survcoef[2], intercept = survcoef[1], color = "blue", lwd = 1) +
  geom_line(data = predict.int.survmod, aes(x = x.vals, y = lower), color = "blue", linetype = "dashed") +
  geom_line(data = predict.int.survmod, aes(x = x.vals, y = upper), color = "blue", linetype = "dashed") +
  theme(axis.title.x = element_text(size = 20))

uneq.normal.plot <- base +
  geom_point(data = anthuneq, aes(finger, height), size = size.uneq) +
  geom_abline(slope = normalcoef[2], intercept = normalcoef[1], color = "red", lwd = 1) +
  geom_line(data = predict.int.normalmod, aes(x = x.vals, y = lwr), color = "red", linetype = "dashed") +
  geom_line(data = predict.int.normalmod, aes(x = x.vals, y = upr), color = "red", linetype = "dashed") +
  theme(axis.title.x = element_text(size = 20))

srs.surv.plot <- base +
  geom_point(data = anthsrs, aes(finger, height), size = size.srs) +
  geom_abline(slope = survcoef[2], intercept = survcoef[1], color = "blue", lwd = 1) +
  geom_line(data = predict.int.survmod, aes(x = x.vals, y = lower), color = "blue", linetype = "dashed") +
  geom_line(data = predict.int.survmod, aes(x = x.vals, y = upper), color = "blue", linetype = "dashed") +
  theme(axis.title.x = element_text(size = 20))

srs.normal.plot <- base +
  geom_point(data = anthsrs, aes(finger, height), size = size.srs) +
  geom_abline(slope = normalcoef[2], intercept = normalcoef[1], color = "red", lwd = 1) +
  geom_line(data = predict.int.normalmod, aes(x = x.vals, y = lwr), color = "red", linetype = "dashed") +
  geom_line(data = predict.int.normalmod, aes(x = x.vals, y = upr), color = "red", linetype = "dashed") +
  theme(axis.title.x = element_text(size = 20))

plot_grid(uneq.normal.plot, uneq.surv.plot, srs.normal.plot, srs.surv.plot, ncol = 2, labels = "AUTO")
```


```{r}
size.uneq <- rep(0.8, length(nrow(anthuneq)))
size.srs <- rep(0.8, length(nrow(anthuneq)))

base <- ggplot() + xlim(10, 13) + ylim(145, 191)

uneq.plot <- base +
  geom_ribbon(aes(x = x.vals, ymin = lower, ymax = upper), data = predict.int.survmod, fill = "blue", alpha = 0.5) +
  geom_ribbon(aes(x = x.vals, ymin = lwr, ymax = upr), data = predict.int.normalmod, fill = "red", alpha = 0.5) +
  geom_point(data = anthuneq, aes(finger, height), size = size.uneq) +
  geom_abline(slope = survcoef[2], intercept = survcoef[1], color = "blue", lwd = 1) +
  geom_line(data = predict.int.survmod, aes(x = x.vals, y = lower), color = "blue", linetype = "dashed") +
  geom_line(data = predict.int.survmod, aes(x = x.vals, y = upper), color = "blue", linetype = "dashed") +
  geom_abline(slope = normalcoef[2], intercept = normalcoef[1], color = "red", lwd = 1) +
  geom_line(data = predict.int.normalmod, aes(x = x.vals, y = lwr), color = "red", linetype = "dashed") +
  geom_line(data = predict.int.normalmod, aes(x = x.vals, y = upr), color = "red", linetype = "dashed") +
  theme(axis.title.x = element_text(size = 20))

srs.plot <- base +
  geom_point(data = anthsrs, aes(finger, height), size = size.srs) +
  geom_abline(slope = survcoef[2], intercept = survcoef[1], color = "blue", lwd = 1) +
  geom_line(data = predict.int.survmod, aes(x = x.vals, y = lower), color = "blue", linetype = "dashed") +
  geom_line(data = predict.int.survmod, aes(x = x.vals, y = upper), color = "blue", linetype = "dashed") +
  geom_abline(slope = normalcoef[2], intercept = normalcoef[1], color = "red", lwd = 1) +
  geom_line(data = predict.int.normalmod, aes(x = x.vals, y = lwr), color = "red", linetype = "dashed") +
  geom_line(data = predict.int.normalmod, aes(x = x.vals, y = upr), color = "red", linetype = "dashed") +
  theme(axis.title.x = element_text(size = 20))


plot_grid(uneq.plot, srs.plot, nrow = 2, labels = "AUTO")
```


## Stratification

```{r}
apistrat %>% filter(stype == "H") %>% nrow
apistrat %>% filter(stype == "M") %>% nrow
apistrat %>% filter(stype == "E") %>% nrow

apipop %>% filter(stype == "H") %>% nrow
apipop %>% filter(stype == "M") %>% nrow
apipop %>% filter(stype == "E") %>% nrow
```

```{r}
svy.srs <- svydesign(id = ~1, weights = ~pw, data = apisrs, fpc = ~fpc)
svy.strat <- svydesign(id=~1,strata=~stype, weights=~pw, data=apistrat, fpc=~fpc)

svymean(~api00, svy.srs)
svymean(~api00, svy.strat)
```

```{r}
apipop %>% filter(hsg > 30) %>% transmute(mean = mean(api00))
foo <- apipop %>% filter(hsg > 30) %>% select(api00) %>% mean
mean((apipop %>% filter(hsg < 40) %>% filter(hsg > 30))$api00)
mean((apipop %>% filter(hsg > 70))$api00)
mean((apipop %>% filter(col.grad < 20))$api00)
mean((apipop %>% filter(col.grad > 20) %>% filter(col.grad < 40))$api00)
mean((apipop %>% filter(col.grad > 40))$api00)

length((apipop %>% filter(col.grad < 20))$api00)
length((apipop %>% filter(col.grad > 20) %>% filter(col.grad < 40))$api00)
length((apipop %>% filter(col.grad > 40))$api00)
```

```{r}
api.less.than.20 <- apipop %>% filter(col.grad < 20)
api.less.than.20$pw <- nrow(api.less.than.20)/100
api.less.than.20$fpc <- 1 - 1/api.less.than.20$pw

api.between.20.40 <- apipop %>% filter(col.grad > 20) %>% filter(col.grad < 40)
api.between.20.40$pw <- nrow(api.between.20.40)/100
api.between.20.40$fpc <- 1 - 1/api.between.20.40$pw

api.more.than.40 <- apipop %>% filter(col.grad > 40)
api.more.than.40$pw <- nrow(api.more.than.40)/100
api.more.than.40$fpc <- 1 - 1/api.more.than.40$pw

apistratcol <- api.less.than.20[sample(1:nrow(api.less.than.20), 100, replace = F),]
apistratcol <- rbind(apistratcol, api.between.20.40[sample(1:nrow(api.between.20.40), 100, replace = F),])
apistratcol <- rbind(apistratcol, api.more.than.40[sample(1:nrow(api.more.than.40), 100, replace = F),])

```


```{r}
svy.srs <- svydesign(id = ~1, weights = ~pw, data = apisrs, fpc = ~fpc)
svy.strat <- svydesign(id=~1,strata=~stype, weights=~pw, data=apistratcol, fpc=~fpc)

svymean(~api00, svy.srs)
svymean(~api00, svy.strat)
```